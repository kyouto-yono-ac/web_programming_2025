# 第7回 Streamlit発展 (2): 状態管理 (st.session_state)

## 基本情報

- **授業時間:** 90分 (実質70-80分程度を想定)
- **形式:** 講義 + 演習 (Streamlit Cloud + GitHub.dev または ローカル環境)
- **必要機材:** ノートPC、インターネット接続、GitHubアカウント

## 授業の目標

この授業では、Streamlit アプリケーションの状態を管理し、ウィジェット間の連携や複数回のインタラクションを通じて情報を保持・活用するための `st.session_state` の使い方を習得します。
具体的には以下の点を目標とします。

1.  **Streamlit の再実行モデルの理解:** ウィジェット操作時にスクリプト全体が再実行されることを理解し、その挙動によって変数の値がリセットされる問題を認識する。
2.  **`st.session_state` の導入:** アプリケーションのセッション間で情報を保持するための `st.session_state` の基本的な使い方（値の初期化、参照、更新）を学ぶ。
3.  **ウィジェットとの連携:** 入力ウィジェットの値を `st.session_state` に保存し、他のウィジェットや処理で利用する方法を学ぶ。
4.  **状態の初期化:** `st.session_state` にキーが存在しない場合にのみ初期値を設定するパターンを学ぶ。
5.  **コールバック関数の利用:** ボタンなどのウィジェット操作時に特定の関数（コールバック）を実行させ、状態を更新する方法を学ぶ。
6.  **実践的な応用例:** `st.session_state` を使ったカウンター、ToDoリスト、複数ステップのフォームなどの簡単な例を通じて理解を深める。

## タイムスケジュール (目安)

| 時間       | 内容                                   | 詳細                                                                                   |
| ---------- | -------------------------------------- | -------------------------------------------------------------------------------------- |
| 00:00-00:10 | 前回の復習と「状態」の問題点           | 入力ウィジェット復習、再実行モデルの説明、変数がリセットされる問題のデモ               |
| 00:10-00:25 | `st.session_state` の基本            | 導入、辞書ライクな操作 (初期化、参照、更新)、簡単な値保持のデモと演習                 |
| 00:25-00:40 | ウィジェットと `st.session_state` の連携 | 入力値を Session State に保存、Session State の値に基づいて表示を変化させる例と演習 |
| 00:40-00:55 | コールバック関数 (`on_change`, `args`) | ウィジェット操作時に状態を更新するコールバック関数の使い方、引数の渡し方の説明と演習 |
| 00:55-01:15 | 応用例と実践演習                       | カウンターアプリ、簡単な ToDo リストなどの実装演習                                     |
| 01:15-01:20 | まとめとベストプラクティス             | `st.session_state` の要点整理、使い方の注意点                                          |
| 01:20-01:25 | 次回予告                               | 次回 (データ処理入門 Pandas) の予告、質疑応答                                          |

## 授業内容の詳細

### 1. 前回の復習と「状態」の問題点 (10分)
- 前回の授業で学んだ各種入力ウィジェット (`st.button`, `st.selectbox`, `st.slider` など) を簡単に振り返ります。
- Streamlit がインタラクティブな操作（ボタンクリック、値の変更など）のたびに **スクリプト全体を上から再実行する** という動作モデルを説明します。
- この再実行により、通常の Python 変数の値が保持されず、インタラクション間で状態を維持できない問題点を簡単なデモ（例: ボタンを押してもカウンターが増えない）で示します。

### 2. `st.session_state` の基本 (15分)
- スクリプトの再実行をまたいで情報を保持するための仕組み `st.session_state` を導入します。
- `st.session_state` が Python の辞書 (dictionary) のように扱えることを説明します。
    - **初期化:** `if 'キー名' not in st.session_state:` のパターンで初回実行時のみ値を設定する。
    - **参照:** `st.session_state.キー名` または `st.session_state['キー名']` で値を取得する。
    - **更新:** `st.session_state.キー名 = 新しい値` または `st.session_state['キー名'] = 新しい値` で値を更新する。
- 簡単な値（カウンターなど）を `st.session_state` で保持するデモと演習を行います。

### 3. ウィジェットと `st.session_state` の連携 (15分)
- 入力ウィジェット (例: `st.text_input`) の値を `st.session_state` に保存する方法を学びます。
    - `key` 引数を使ってウィジェットの値を直接 `st.session_state` の特定のキーに関連付ける方法 (`st.text_input("ラベル", key="my_text")`) を紹介します。
- `st.session_state` に保存された値を使って、アプリの表示を動的に変更する例を示します。

### 4. コールバック関数 (`on_change`, `args`) (15分)
- ウィジェットの値が変更されたときやボタンがクリックされたときに、特定の Python 関数（コールバック関数）を自動的に実行させる方法を学びます。
- `on_change` 引数に関数名を指定します。
- `args` 引数を使ってコールバック関数に追加の引数を渡す方法を説明します。
- コールバック関数内で `st.session_state` を更新することで、より複雑な状態遷移を実装できることを示します。
- 例: ボタンクリックでカウンターを増やす関数をコールバックとして登録する。

### 5. 応用例と実践演習 (20分)
- `st.session_state` とコールバック関数を使って、以下のような少し複雑なインタラクティブアプリの実装演習を行います。
    - **カウンターアプリ:** ボタンで数値を増減させる。
    - **簡単な ToDo リスト:** テキスト入力でタスクを追加し、リスト表示する (削除機能は省略または簡易的に)。

### 6. まとめとベストプラクティス (5分)
- `st.session_state` が Streamlit でインタラクティブなアプリを作る上で非常に重要であることを再確認します。
- 状態の初期化パターン (`if 'key' not in ...`) の重要性を強調します。
- コールバック関数による状態更新の流れを整理します。
- `st.session_state` を使いすぎるとコードが複雑になる可能性にも触れます。

### 7. 次回予告 (5分)
- 次回はデータ分析ライブラリ Pandas の入門と、CSV/Excel ファイルの読み込み (`st.file_uploader`) について学ぶことを予告します。
- 質疑応答の時間を設けます。

## 準備物

### 教員側
- 講義用スライド (`07_slide.md`)
- 講義用サンプルコードリポジトリ (GitHub)
- 演習用課題指示

### 学生側
- ノートPC
- インターネット接続環境
- GitHubアカウント
- (推奨) 前回の授業内容 (Streamlit 入力ウィジェット) の理解

## 配布資料

- 講義用スライド PDF (`07_slide.pdf` - Marp で変換後)
- サンプルコードへのリンク (GitHub)
- 演習課題

## 次回予告

- **第8回: データ処理入門 (Pandas)**
- Pandas ライブラリの基礎、CSV/Excel ファイルの読み込み (`st.file_uploader`)、データフレーム操作などを学びます。 